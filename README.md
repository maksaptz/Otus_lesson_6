#  Управление пакетами. Дистрибьюция софта 
## Цель домашнего задания:
Научиться самостоятельно собирать пакет из исходников и публиковать его в собственном репозитории. 

В работе использовался vagrant box: "generic/debian10" version "4.2.16"

Использовалась дополнительная информация со следующих электронных ресурсов:

https://habr.com/ru/articles/78094/<br/>
https://interface31.ru/tech_it/2020/03/sozdaem-sobstvennyy-repozitoriy-dlya-1spredpriyatie-v-srede-linux.html

Описание домашнего задания:

1) Создать свой DEB пакет;
2) Создать свой репозиторий и разместиь там ранее собранный DEB-пакет.

### Создать свой DEB пакет

 Для создания пакета будем использовать стандартную утилиту dpkg-deb.
 Установим необходимы пакеты:
 
 `sudo apt-get install -y dpkg debconf debhelper fakeroot`
 
 Создаем директории для будущего пакета:  <br/>
 `mkdir ~/supersh` <br/>
 `mkdir -p ~/supersh/DEBIAN` # управляющая папка  <br/>
 `mkdir -p ~/supersh/usr/bin` # путь к скрипту   <br/>
 `cp super.sh ~/supersh/usr/bin/` # копируем наш скрипт в нужное место   <br/>
 
 В нашем примере реально используется только обязательный файл DEBIAN/control:

`Package: supersh` <br/>
`Version: 1.0-1` <br/>
`Section: misc`  <br/>
`Architecture: all`  <br/>
`Maintainer: Test <testov.ru>`  <br/>
`Description: Super Shell Script`  <br/>

Впринципе этого уже достаточно для сборки минимального пакета: <br/>
`fakeroot dpkg-deb --build supersh` <br/>
Переименовываем файл в соответсвии со стандартами:<br/>
`mv supersh.deb supersh_1.0-1_all.deb`<br/>

Пакет готов теперь необходимо его разместить.

### Создать свой репозиторий и разместить там ранее собранный DEB-пакет
Для размещения пакета был настроен рабочий веб-сервер на базе Apache.
Репозиторий был создан с помощью утилиты aptly
`apt install aptly`

Следующим шагом нам потребуется создать конфигурационный файл, при установке утилиты не создается ни файла конфигурации, ни структуры репозитория, но есть одна небольшая хитрость, выполним:

aptly config show

В ответ на нашу просьбу показать настройки утилита сообщит нам что файл не найден и создаст конфигурацию с настройками по умолчанию в корневой директории пользователя, от имени которого была выполнена команда.

Config file not found, creating default config at /root/.aptly.conf

Как видно из вывода, в нашем случае путь к файлу /root/.aptly.conf, переместим его в более привычное расположение - /etc:

mv /root/.aptly.conf /etc/aptly.conf

Обратите внимание, что в исходном расположении имя файла начинается с точки (скрытый файл) при перемещении в /etc точку следует убрать.

Затем откроем его и изменим следующую настройку:

"rootDir": "/opt/aptly",

Она задает расположение репозитория и по умолчанию предлагает разместить его в домашней директории, мы не считаем это хорошим решением, поэтому изменили путь на /opt/aptly, но вы можете использовать любое иное расположение, главное - чтобы там было необходимое количество свободного места.

На этом настройки утилиты закончены, можно приступить к созданию собственного репозитория. Точнее двух. В одном мы будем держать самые новые пакеты для условной бухгалтерии, в другом - более старые, для условного производства.

Для создания репозитория выполним:

aptly repo create --comment="1C Enterprise" --distribution="stable" --architectures="i386,amd64" --component="non-free" stable

Параметры команды следует рассмотреть подробнее: comment - комментарии, тут все понятно, необязательный параметр, distribution - выпуск или релиз, обычно здесь указывается кодовое наименование дистрибутива для которого предназначен репозитории или тип выпуска (стабильный, тестовый и т.д.), architectures - архитектура пакетов, так как 1С содержит пакеты только двух архитектур - указываем их, component - указывает ветку репозитория, согласно принятому в Debian соглашении пакеты делятся на свободные - free, с включением закрытых компонентов - contrib и несвободные - non-free. Последним параметром в строке идет внутренне имя репозитория.

При этом все значения, кроме architectures, вы можете задать на собственное усмотрение. Но мы советуем придерживаться следующих соображений, параметр distribution должен давать представление о назначении репозитория, поэтому мы решили выбрать значение stable для первого репозитория с последними версиями пакетов, и oldstable для второго. Также есть еще один момент, в некоторых командах Aptly требуется указывать имя репозитория, а в некоторых - distribution, чтобы уменьшить путаницу внутреннее имя и distribution стоит сделать одинаковыми.

Точно также создадим второй репозиторий:

aptly repo create --comment="1C Enterprise" --distribution="oldstable" --architectures="i386,amd64" --component="non-free" oldstable

Репозитории созданы, теперь в них нужно добавить пакеты. Скачаем с сайта 1С пакеты клиента и сервера для обеих архитектур (если вам не нужны пакеты какой-либо архитектуры, скажем i386, можете их не добавлять и вообще создать репозиторий без их поддержки). Мы скачали пакеты платформы 8.3.15 для stable и 8.3.14 для oldstable, эти архивы следует передать на сервер и распаковать, каждую платформу в свою директорию, в нашем случае это будут условные 1С14 и 1С15, которые предварительно нужно создать.

Будем считать, что скачанные архивы находятся в домашней директории пользователя root, там же создадим каталоги.

cd /root
mkdir 1C14 1C15

Для распаковки архивов воспользуйтесь командой:

tar -xzvf deb_8_3_14_1993.tar.gz -C 1C14

Ее необходимо выполнить для каждого архива, соответственно изменив имя в команде, а опция -С - указывает целевую директорию назначения. Пакеты обоих архитектур можно спокойно распаковывать в одну и ту же папку.

После того, как вы распаковали все архивы, добавим пакеты из наших директорий в репозитории:

aptly repo add stable /root/1C15
aptly repo add oldstable /root/1C14

1c-repo-001.png

Синтаксис команды прост, в качестве параметров указываем внутреннее имя репозитория и каталог с пакетами.

Теперь мы вплотную подошли к одному важному моменту - публикации репозитория. Вы можете добавлять или удалять пакеты, но все изменения будут применены только тогда, когда вы опубликуете репозиторий (или обновите публикацию). Это позволяет, например, спокойно добавить пакеты в рабочее время, а публикацию выполнить вечером, не создавая неудобств работающим коллегам и сэкономив при этом свое личное время.

Так как наш репозиторий является сугубо внутренним и полностью нами контролируется, то мы не будем использовать цифровую подпись, а также ограничимся для доступа протоколом HTTP.

Для публикации следует выполнить:

aptly publish repo -skip-signing stable



